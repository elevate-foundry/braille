<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SymbiOS Watch Interface</title>
    <style>
        @font-face {
            font-family: 'BrailleFont';
            src: url('https://cdn.jsdelivr.net/npm/braille-font@1.0.0/BrailleFont.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'BrailleFont';
            src: url('https://cdn.jsdelivr.net/npm/braille-font@1.0.0/BrailleFont.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }
        
        :root {
            --primary-color: #1a73e8;
            --secondary-color: #4285f4;
            --accent-color: #34a853;
            --warning-color: #fbbc05;
            --error-color: #ea4335;
            --background-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color: #202124;
            --text-secondary: #5f6368;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 2.2rem;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.2rem;
            margin-top: 0;
            color: var(--text-color);
            display: flex;
            align-items: center;
        }

        .card-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .card-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
            color: var(--primary-color);
        }

        .card-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--card-bg-color);
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .status-indicator {
            display: flex;
            align-items: center;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-dot.connected {
            background-color: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color);
        }

        .status-dot.disconnected {
            background-color: var(--error-color);
        }

        .status-dot.connecting {
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.5;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.5;
            }
        }
        
        /* Braille Haptic Messaging Styles */
        .braille-message-container {
            margin: 20px 0;
            background-color: var(--card-bg-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .message-input-container {
            margin: 15px 0;
        }
        
        #brailleMessage {
            width: 100%;
            height: 100px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            resize: vertical;
        }
        
        .braille-preview {
            margin: 15px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        
        .braille-unicode {
            font-family: 'BrailleFont', sans-serif;
            font-size: 24px;
            min-height: 40px;
            padding: 10px 0;
            letter-spacing: 2px;
        }
        
        .braille-history {
            margin-top: 20px;
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
        }
        
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-message {
            flex: 1;
        }
        
        .history-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .history-braille {
            font-family: 'BrailleFont', sans-serif;
            margin-top: 5px;
            font-size: 18px;
        }
        
        .setting-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .setting-item label {
            min-width: 120px;
            margin-right: 10px;
        }
        
        .setting-item select, .setting-item input[type="range"] {
            flex: 1;
            max-width: 300px;
        }
        
        #intensityValue {
            margin-left: 10px;
            min-width: 30px;
            text-align: center;
        }

        .status-text {
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        button.secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        button.secondary:hover {
            background-color: rgba(26, 115, 232, 0.1);
        }

        .chart-container {
            grid-column: 1 / -1;
            height: 300px;
            background-color: var(--card-bg-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        /* Tab styles */
        .tabs {
            display: flex;
            background-color: var(--card-bg-color);
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: 500;
        }
        
        .tab:hover {
            background-color: rgba(26, 115, 232, 0.1);
        }
        
        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Terminal styles */
        .terminal-container {
            margin-top: 20px;
        }
        
        .terminal {
            background-color: #1e1e1e;
            color: #f0f0f0;
            font-family: monospace;
            padding: 15px;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
        }
        
        .terminal-input-container {
            display: flex;
            gap: 10px;
        }
        
        .terminal-input-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
        }
        
        /* Settings styles */
        .settings-container {
            margin-top: 20px;
        }
        
        .settings-section {
            background-color: var(--card-bg-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .setting-actions {
            margin-top: 15px;
        }
        
        /* Switch toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .slider.round {
            border-radius: 34px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }
        
        /* SymbiOS card styles */
        .symbios-card {
            margin-top: 20px;
        }
        
        .symbios-status-container {
            padding: 10px 0;
        }
        
        .symbios-status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .symbios-progress-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .symbios-progress {
            height: 100%;
            width: 0%;
            background-color: var(--accent-color);
            transition: width 0.3s ease;
        }
        
        .symbios-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Developer tab styles */
        .developer-container {
            margin-top: 20px;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .last-updated {
            text-align: right;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .battery-indicator {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .battery-level {
            height: 100%;
            background-color: var(--accent-color);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .battery-level.low {
            background-color: var(--error-color);
        }

        .battery-level.medium {
            background-color: var(--warning-color);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #heartRateChart {
            width: 100%;
            height: 100%;
        }
    </style>
    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script type="module" src="./braille-haptic-messenger.js"></script>
</head>
<body>
    <header>
        <h1>SymbiOS Watch Interface</h1>
        <div class="subtitle">Modify and control your Galaxy Watch through SymbiOS</div>
    </header>
    
    <!-- Tab Navigation -->
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">Dashboard</div>
            <div class="tab" data-tab="developer">Developer</div>
            <div class="tab" data-tab="terminal">Terminal</div>
            <div class="tab" data-tab="braille">Braille Haptic</div>
            <div class="tab" data-tab="fingerprint">Fingerprint Auth</div>
            <div class="tab" data-tab="settings">Settings</div>
        </div>
        
        <!-- Tab Contents -->
    </header>

    <div class="container">
        <div class="connection-status">
            <div class="status-indicator">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span class="status-text" id="statusText">Disconnected</span>
            </div>
            <div class="actions">
                <button id="connectButton">Connect to Watch</button>
                <button id="disconnectButton" disabled class="secondary">Disconnect</button>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="loading-spinner"></div>
            <p>Scanning for Samsung watches...</p>
        </div>

            <div class="tab-content" id="dashboard-content" data-tab="dashboard">
            <div class="card">
                <h3 class="card-title">Heart Rate</h3>
                <div class="card-value" id="heartRateValue">--</div>
                <div class="card-description">Beats per minute (BPM)</div>
            </div>

            <div class="card">
                <h3 class="card-title">Battery</h3>
                <div class="card-value" id="batteryValue">--%</div>
                <div class="battery-indicator">
                    <div class="battery-level" id="batteryLevel" style="width: 0%"></div>
                </div>
                <div class="card-description">Remaining battery life</div>
            </div>

            <div class="card">
                <h3 class="card-title">Steps</h3>
                <div class="card-value" id="stepsValue">--</div>
                <div class="card-description">Steps taken today</div>
            </div>

            <div class="chart-container">
                <h3 class="card-title">Heart Rate History</h3>
                <canvas id="heartRateChart"></canvas>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">Last updated: Never</div>
        
        <!-- Fingerprint Authentication Tab Content -->
        <div class="tab-content" id="fingerprint-content" data-tab="fingerprint" style="display: none;">
            <h2>Fingerprint Authentication</h2>
            
            <div class="card">
                <h3 class="card-title">Phone Authentication</h3>
                <p class="card-description">Connect to your phone via Bluetooth and use your fingerprint for authentication, similar to GitHub's approach.</p>
                
                <div class="connection-status">
                    <div class="status-indicator">
                        <div class="status-dot disconnected" id="bluetoothStatusDot"></div>
                        <span class="status-text" id="bluetoothStatusText">Bluetooth not connected</span>
                    </div>
                </div>
                
                <div class="actions" style="margin-top: 20px;">
                    <button id="connectBluetoothButton" class="primary">Connect via Bluetooth</button>
                    <button id="connectAllBluetoothButton" class="primary">Show All Devices</button>
                    <button id="disconnectBluetoothButton" disabled class="secondary">Disconnect</button>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">Authentication Status</h3>
                <div class="auth-status-container">
                    <div class="auth-status" id="authStatus">
                        <i class="fas fa-fingerprint" style="font-size: 48px; color: var(--text-secondary);"></i>
                        <p>Not authenticated</p>
                    </div>
                </div>
                
                <div class="actions" style="margin-top: 20px;">
                    <button id="requestAuthButton" disabled class="primary">Request Authentication</button>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">Haptic Feedback After Authentication</h3>
                <p class="card-description">Send haptic feedback to your phone after successful authentication.</p>
                
                <div class="setting-item">
                    <label for="authHapticMode">Haptic Mode:</label>
                    <select id="authHapticMode" disabled>
                        <option value="standard">Standard</option>
                        <option value="rhythmic">Rhythmic</option>
                        <option value="frequency">Frequency-based</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="authHapticIntensity">Intensity:</label>
                    <input type="range" id="authHapticIntensity" min="0.1" max="1.0" step="0.1" value="0.5" disabled>
                    <span id="authHapticIntensityValue">0.5</span>
                </div>
                
                <div class="setting-item">
                    <label for="authBrailleMessage">Braille Message:</label>
                    <input type="text" id="authBrailleMessage" placeholder="Enter message to send after authentication" disabled>
                </div>
                
                <div class="braille-preview">
                    <label>Braille Preview:</label>
                    <div class="braille-text" id="authBraillePreview"></div>
                </div>
                
                <div class="actions" style="margin-top: 20px;">
                    <button id="sendAuthHapticButton" disabled class="primary">Send Authenticated Haptic Message</button>
                </div>
            </div>
        </div>
        
        <!-- Braille Haptic Tab Content -->
        <div class="tab-content" id="braille-content" data-tab="braille" style="display: none;">
            <h2>Braille Haptic Messaging</h2>
            
            <div class="connection-options">
                <div class="card">
                    <h3 class="card-title">Connection Method</h3>
                    <div class="card-content">
                        <div class="setting-row">
                            <label for="connectionMethod">Choose connection method:</label>
                            <select id="connectionMethod" onchange="toggleConnectionMethod()">
                                <option value="usb">USB (ADB)</option>
                                <option value="bluetooth">Bluetooth</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- USB Connection Status -->
            <div class="connection-status" id="usbConnectionStatus">
                <div class="status-indicator">
                    <div class="status-dot disconnected" id="phoneStatusDot"></div>
                    <span class="status-text" id="phoneStatusText">Phone not connected</span>
                </div>
                <div class="actions">
                    <button id="refreshPhoneConnection" class="secondary" onclick="checkPhoneConnection()">Refresh Connection</button>
                </div>
            </div>
            
            <!-- Bluetooth Connection Controls -->
            <div class="connection-status" id="bluetoothConnectionControls" style="display: none;">
                <div class="card">
                    <h3 class="card-title">Bluetooth Connection</h3>
                    <div class="card-content">
                        <div class="status-indicator">
                            <div class="status-dot disconnected" id="brailleBluetoothStatusDot"></div>
                            <span class="status-text" id="brailleBluetoothStatusText">Not connected</span>
                        </div>
                        <div class="button-group">
                            <button class="btn primary" id="connectBrailleBluetoothBtn" onclick="connectBrailleViaBluetooth()">Connect via Bluetooth</button>
                            <button class="btn" id="disconnectBrailleBluetoothBtn" onclick="disconnectBrailleViaBluetooth()" disabled>Disconnect</button>
                        </div>
                        
                        <!-- Authentication Status Indicator -->
                        <div class="status-indicator" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                            <div class="status-dot disconnected" id="brailleAuthStatusDot"></div>
                            <span class="status-text" id="brailleAuthStatusText">Not authenticated</span>
                            <button class="btn secondary" id="brailleAuthButton" onclick="switchTab('fingerprint')">Authenticate</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="braille-message-container">
                <div class="setting-item">
                    <label for="hapticMode">Haptic Mode:</label>
                    <select id="hapticMode">
                        <option value="standard">Standard</option>
                        <option value="rhythmic">Rhythmic</option>
                        <option value="frequency">Frequency-based</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <label for="hapticIntensity">Intensity:</label>
                    <input type="range" id="hapticIntensity" min="0.1" max="1.0" step="0.1" value="1.0">
                    <span id="intensityValue">1.0</span>
                </div>
                
                <div class="message-input-container">
                    <label for="brailleMessage">Message to send as haptic braille:</label>
                    <textarea id="brailleMessage" placeholder="Type your message here..."></textarea>
                </div>
                
                <div class="braille-preview">
                    <label>Braille Preview:</label>
                    <div id="brailleUnicodePreview" class="braille-unicode"></div>
                </div>
                
                <button id="sendBrailleMessage" class="primary-button">
                    Send Haptic Message
                </button>
            </div>
            
            <div class="braille-history">
                <h3>Message History</h3>
                <div id="brailleHistoryList" class="history-list"></div>
            </div>
        </div>
    </div>

    <script>
        // Global functions for HTML event handlers
        function toggleConnectionMethod() {
            const connectionMethod = document.getElementById('connectionMethod').value;
            const usbConnectionStatus = document.getElementById('usbConnectionStatus');
            const bluetoothConnectionControls = document.getElementById('bluetoothConnectionControls');
            
            if (connectionMethod === 'usb') {
                usbConnectionStatus.style.display = 'block';
                bluetoothConnectionControls.style.display = 'none';
                window.checkPhoneConnection();
            } else {
                usbConnectionStatus.style.display = 'none';
                bluetoothConnectionControls.style.display = 'block';
            }
        }
        
        function connectBrailleViaBluetooth() {
            window.connectBrailleViaBluetooth();
        }
        
        function disconnectBrailleViaBluetooth() {
            window.disconnectBrailleViaBluetooth();
        }
        
        function checkPhoneConnection() {
            window.checkPhoneConnection();
        }
        
        function sendBrailleMessage() {
            window.sendBrailleMessage();
        }
    </script>
    
    <script type="module">
        import SamsungWatchConnector from './samsung-watch-connector.js';
        import BrailleHapticMessenger from './braille-haptic-messenger.js';
        import FingerprintAuthenticator from './fingerprint-authenticator.js';
        import BluetoothConnector from './bluetooth-connector.js';

        // Initialize variables for components
        let watchConnector;
        let brailleMessenger;
        let fingerprintAuth;
        let bluetoothConnector;
        let brailleBluetoothConnector; // Separate connector for braille messaging
        let heartRateChart;
        let heartRateData = [];
        let timeLabels = [];
        const MAX_DATA_POINTS = 20;

        // DOM elements
        const connectButton = document.getElementById('connectButton');
        const disconnectButton = document.getElementById('disconnectButton');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const heartRateValue = document.getElementById('heartRateValue');
        const batteryValue = document.getElementById('batteryValue');
        const batteryLevel = document.getElementById('batteryLevel');
        const stepsValue = document.getElementById('stepsValue');
        const lastUpdated = document.getElementById('lastUpdated');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Initialize the heart rate chart
        function initChart() {
            const ctx = document.getElementById('heartRateChart').getContext('2d');
            heartRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Heart Rate (BPM)',
                        data: heartRateData,
                        borderColor: '#1a73e8',
                        backgroundColor: 'rgba(26, 115, 232, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            suggestedMin: 40,
                            suggestedMax: 160
                        }
                    },
                    animation: {
                        duration: 500
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update the UI with watch data
        function updateUI(data) {
            if (data.heartRate > 0) {
                heartRateValue.textContent = data.heartRate;
                
                // Update chart data
                const now = new Date();
                const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + 
                                 now.getMinutes().toString().padStart(2, '0') + ':' + 
                                 now.getSeconds().toString().padStart(2, '0');
                
                heartRateData.push(data.heartRate);
                timeLabels.push(timeLabel);
                
                // Keep only the last MAX_DATA_POINTS data points
                if (heartRateData.length > MAX_DATA_POINTS) {
                    heartRateData.shift();
                    timeLabels.shift();
                }
                
                // Update the chart
                heartRateChart.data.labels = timeLabels;
                heartRateChart.data.datasets[0].data = heartRateData;
                heartRateChart.update();
            }
            
            if (data.batteryLevel > 0) {
                batteryValue.textContent = data.batteryLevel + '%';
                batteryLevel.style.width = data.batteryLevel + '%';
                
                // Update battery level color based on percentage
                if (data.batteryLevel < 20) {
                    batteryLevel.className = 'battery-level low';
                } else if (data.batteryLevel < 50) {
                    batteryLevel.className = 'battery-level medium';
                } else {
                    batteryLevel.className = 'battery-level';
                }
            }
            
            if (data.steps > 0) {
                stepsValue.textContent = data.steps.toLocaleString();
            }
            
            if (data.lastUpdated) {
                lastUpdated.textContent = 'Last updated: ' + data.lastUpdated.toLocaleString();
            }
        }

        // Initialize the application
        // SymbiOS state management
        const symbiosState = {
            initialized: false,
            connected: false,
            installStatus: 'pending', // pending, installing, installed
            osVersion: '0.1.0',
            lastSync: null,
            hapticFeedback: false,
            brailleEnabled: false,
            syncEnabled: false
        };
        
        // Initialize Monaco Editor
        function initMonacoEditor() {
            require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' }});
            require(['vs/editor/editor.main'], function() {
                window.editor = monaco.editor.create(document.getElementById('code-editor-container'), {
                    value: `// SymbiOS Watch Script
// Edit and deploy directly to your watch

const config = {
  version: "0.1.0",
  deviceType: "watch",
  syncInterval: 5000,  // ms
};

// State management
let state = {
  connected: false,
  batteryLevel: 0,
  lastSync: null,
  phoneConnected: false,
  macConnected: false,
};

// Initialize
function initialize() {
  console.log("SymbiOS Watch Agent initializing...");
  
  // Start state monitoring
  monitorState();
  
  // Start sync loop
  setInterval(syncState, config.syncInterval);
  
  console.log("SymbiOS Watch Agent initialized");
}

// Monitor device state
function monitorState() {
  // Battery monitoring would go here
  
  // Connection status would go here
}

// Sync state with phone/Mac
function syncState() {
  state.lastSync = new Date();
  // Sync code would go here
}

// Start the agent
initialize();`,
                    language: 'javascript',
                    theme: 'vs-dark',
                    automaticLayout: true
                });
            });
        }
        
        // Tab switching functionality
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const dashboardContent = document.getElementById('dashboard-content');
            
            // Show dashboard by default
            dashboardContent.style.display = 'block';
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Hide all tab contents
                    tabContents.forEach(c => c.style.display = 'none');
                    if (dashboardContent) dashboardContent.style.display = 'none';
                    
                    // Add active class to clicked tab
                    tab.classList.add('active');
                    
                    // Show the corresponding content
                    if (tabId === 'dashboard') {
                        if (dashboardContent) dashboardContent.style.display = 'block';
                    } else {
                        const content = document.getElementById(`${tabId}-content`);
                        if (content) content.style.display = 'block';
                    }
                    
                    // Initialize Monaco editor when developer tab is selected
                    if (tabId === 'developer' && !window.editor) {
                        initMonacoEditor();
                    }
                });
            });
            
            // Set initial active tab
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabId = activeTab.getAttribute('data-tab');
                if (tabId !== 'dashboard') {
                    const content = document.getElementById(`${tabId}-content`);
                    if (content) {
                        dashboardContent.style.display = 'none';
                        content.style.display = 'block';
                    }
                }
            }
        }
        
        // Terminal functionality
        function initTerminal() {
            const terminal = document.getElementById('terminal');
            const commandInput = document.getElementById('terminal-command');
            const runCommandBtn = document.getElementById('run-command-btn');
            
            function addTerminalLine(text, isCommand = false) {
                const line = document.createElement('div');
                line.textContent = isCommand ? `> ${text}` : text;
                terminal.appendChild(line);
                terminal.scrollTop = terminal.scrollHeight;
            }
            
            function processCommand(command) {
                addTerminalLine(command, true);
                
                // Process commands
                switch(command.toLowerCase()) {
                    case 'help':
                        addTerminalLine('Available commands:');
                        addTerminalLine('  help - Show this help message');
                        addTerminalLine('  status - Show SymbiOS status');
                        addTerminalLine('  install - Install SymbiOS on watch');
                        addTerminalLine('  reset - Reset SymbiOS configuration');
                        addTerminalLine('  deploy - Deploy current script to watch');
                        addTerminalLine('  clear - Clear terminal');
                        break;
                    case 'status':
                        addTerminalLine('SymbiOS Status:');
                        addTerminalLine(`  Installed: ${symbiosState.initialized ? 'Yes' : 'No'}`);
                        addTerminalLine(`  Connected: ${symbiosState.connected ? 'Yes' : 'No'}`);
                        addTerminalLine(`  Version: ${symbiosState.osVersion}`);
                        addTerminalLine(`  Last Sync: ${symbiosState.lastSync ? symbiosState.lastSync.toLocaleString() : 'Never'}`);
                        break;
                    case 'install':
                        addTerminalLine('Starting SymbiOS installation...');
                        installSymbiOS();
                        break;
                    case 'reset':
                        addTerminalLine('Resetting SymbiOS configuration...');
                        resetSymbiOS();
                        break;
                    case 'deploy':
                        addTerminalLine('Deploying script to watch...');
                        deployScript();
                        break;
                    case 'clear':
                        terminal.innerHTML = '';
                        addTerminalLine('Terminal cleared');
                        break;
                    default:
                        addTerminalLine(`Unknown command: ${command}`);
                        addTerminalLine('Type "help" for available commands');
                }
            }
            
            runCommandBtn.addEventListener('click', () => {
                const command = commandInput.value.trim();
                if (command) {
                    processCommand(command);
                    commandInput.value = '';
                }
            });
            
            commandInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const command = commandInput.value.trim();
                    if (command) {
                        processCommand(command);
                        commandInput.value = '';
                    }
                }
            });
        }
        
        // SymbiOS installation simulation
        function installSymbiOS() {
            const statusElement = document.getElementById('symbios-status');
            const progressElement = document.getElementById('symbios-progress');
            
            statusElement.textContent = 'Installing...';
            symbiosState.installStatus = 'installing';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                progressElement.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    statusElement.textContent = 'Installed';
                    symbiosState.initialized = true;
                    symbiosState.installStatus = 'installed';
                    document.getElementById('update-symbios-btn').disabled = false;
                    
                    // Add terminal message
                    const terminal = document.getElementById('terminal');
                    if (terminal) {
                        terminal.innerHTML += '> SymbiOS installation complete\n';
                        terminal.scrollTop = terminal.scrollHeight;
                    }
                }
            }, 200);
        }
        
        // Reset SymbiOS
        function resetSymbiOS() {
            const statusElement = document.getElementById('symbios-status');
            const progressElement = document.getElementById('symbios-progress');
            
            statusElement.textContent = 'Not Installed';
            progressElement.style.width = '0%';
            symbiosState.initialized = false;
            symbiosState.installStatus = 'pending';
            document.getElementById('update-symbios-btn').disabled = true;
            
            // Reset toggles
            document.getElementById('toggle-haptic').checked = false;
            document.getElementById('toggle-braille').checked = false;
            document.getElementById('toggle-sync').checked = false;
            
            // Add terminal message
            const terminal = document.getElementById('terminal');
            if (terminal) {
                terminal.innerHTML += '> SymbiOS reset complete\n';
                terminal.scrollTop = terminal.scrollHeight;
            }
        }
        
        // Deploy script to watch
        function deployScript() {
            if (!window.editor) {
                console.error('Code editor not initialized');
                return;
            }
            
            const code = window.editor.getValue();
            console.log('Deploying script:', code);
            
            // Simulate deployment
            const terminal = document.getElementById('terminal');
            if (terminal) {
                terminal.innerHTML += '> Deploying script to watch...\n';
                terminal.innerHTML += '> Compiling...\n';
                
                setTimeout(() => {
                    terminal.innerHTML += '> Uploading to watch...\n';
                    
                    setTimeout(() => {
                        terminal.innerHTML += '> Script deployed successfully!\n';
                        terminal.scrollTop = terminal.scrollHeight;
                    }, 1000);
                }, 800);
            }
        }
        
        async function init() {
            // Initialize the chart
            initChart();
            
            // Initialize Bluetooth connector
            bluetoothConnector = new BluetoothConnector();
            
            // Initialize tabs
            initTabs();
            
            // Initialize connection method toggle
            toggleConnectionMethod();
            
            // Initialize terminal
            initTerminal();
            
            // Initialize braille haptic messaging
            initBrailleHaptic();
            
            // Initialize fingerprint authentication
            initFingerprintAuth();
            
            // Setup event listeners for SymbiOS controls
            document.getElementById('install-symbios-btn').addEventListener('click', installSymbiOS);
            document.getElementById('reset-symbios-btn').addEventListener('click', resetSymbiOS);
            document.getElementById('deploy-code-btn').addEventListener('click', deployScript);
            
            // Toggle event listeners
            document.getElementById('toggle-haptic').addEventListener('change', (e) => {
                symbiosState.hapticFeedback = e.target.checked;
            });
            
            document.getElementById('toggle-braille').addEventListener('change', (e) => {
                symbiosState.brailleEnabled = e.target.checked;
            });
            
            // Test haptic feedback button
            document.getElementById('test-haptic-btn').addEventListener('click', () => {
                // This would normally trigger haptic feedback on the watch
                alert('Haptic feedback test sent to watch');
            });
            
            // Initialize the Samsung Watch connector
            const initialized = await watchConnector.initialize();
            if (!initialized) {
                statusText.textContent = 'Bluetooth not available';
                connectButton.disabled = true;
                return;
            }
            
            // Register visualization callback
            watchConnector.registerVisualizationCallback(updateUI);
            
            // Connect button event listener
            connectButton.addEventListener('click', async () => {
                // Update UI to show connecting state
                statusDot.className = 'status-dot connecting';
                statusText.textContent = 'Connecting...';
                connectButton.disabled = true;
                loadingIndicator.style.display = 'block';
                
                try {
                    // Connect to the watch
                    const connected = await watchConnector.connectToWatch();
                    
                    if (connected) {
                        // Update UI to show connected state
                        statusDot.className = 'status-dot connected';
                        statusText.textContent = 'Connected to ' + watchConnector.device.name;
                        disconnectButton.disabled = false;
                    } else {
                        // Update UI to show disconnected state
                        statusDot.className = 'status-dot disconnected';
                        statusText.textContent = 'Connection failed';
                        connectButton.disabled = false;
                    }
                } catch (error) {
                    console.error('Connection error:', error);
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'Connection error: ' + error.message;
                    connectButton.disabled = false;
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            });
            
            // Disconnect button event listener
            disconnectButton.addEventListener('click', async () => {
                await watchConnector.disconnect();
                
                // Update UI to show disconnected state
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                
                // Reset data
                heartRateValue.textContent = '--';
                batteryValue.textContent = '--%';
                batteryLevel.style.width = '0%';
                stepsValue.textContent = '--';
            });
        }

        // Initialize braille haptic messaging functionality
        function initBrailleHaptic() {
            // Set default haptic settings
            updateHapticSettings();
            
            // Set up connection method change handler
            document.getElementById('connectionMethod').addEventListener('change', toggleConnectionMethod);
            document.getElementById('refreshPhoneConnection').addEventListener('click', checkPhoneConnection);
            
            // Initialize braille preview
            updateBraillePreview();
            
            // Set up event listeners for braille haptic messaging
            document.getElementById('brailleMessage').addEventListener('input', updateBraillePreview);
            document.getElementById('hapticMode').addEventListener('change', updateHapticSettings);
            document.getElementById('hapticIntensity').addEventListener('input', updateHapticSettings);
            document.getElementById('sendBrailleMessage').addEventListener('click', sendBrailleMessage);
            document.getElementById('refreshPhoneConnection').addEventListener('click', checkPhoneConnection);
        }
        
        // Initialize Fingerprint Authentication
        function initFingerprintAuth() {
            // Add event listeners for Bluetooth connection
            document.getElementById('connectBluetoothButton').addEventListener('click', connectBluetooth);
            document.getElementById('connectAllBluetoothButton').addEventListener('click', connectAllBluetooth);
            document.getElementById('disconnectBluetoothButton').addEventListener('click', disconnectBluetooth);
            document.getElementById('requestAuthButton').addEventListener('click', requestAuthentication);
            document.getElementById('authBrailleMessage').addEventListener('input', updateAuthBraillePreview);
            document.getElementById('sendAuthHapticButton').addEventListener('click', sendAuthenticatedHapticMessage);
            
            // Update auth haptic intensity display
            document.getElementById('authHapticIntensity').addEventListener('input', function() {
                document.getElementById('authHapticIntensityValue').textContent = this.value;
            });
        }
        
        // Update braille preview based on input text
        function updateBraillePreview() {
            const messageText = document.getElementById('brailleMessage').value;
            const previewElement = document.getElementById('brailleUnicodePreview');
            
            if (messageText.trim()) {
                const unicodeBraille = brailleMessenger.getUnicodeBraille(messageText);
                previewElement.textContent = unicodeBraille;
            } else {
                previewElement.textContent = '';
            }
        }
        
        // Update authentication braille preview
        function updateAuthBraillePreview() {
            const messageText = document.getElementById('authBrailleMessage').value;
            const previewElement = document.getElementById('authBraillePreview');
            
            if (!messageText) {
                previewElement.innerHTML = '<span class="empty-preview">Braille preview will appear here</span>';
                return;
            }
            
            // Convert text to braille patterns using the BrailleHapticMessenger
            const braillePatterns = brailleMessenger.textToBraillePatterns(messageText);
            previewElement.innerHTML = braillePatterns.map(pattern => `<span class="braille-char">${pattern}</span>`).join(' ');
        }
        
        // Connect to phone via Bluetooth
        async function connectBluetooth() {
            try {
                // Update UI to show connecting state
                const statusDot = document.getElementById('bluetoothStatusDot');
                const statusText = document.getElementById('bluetoothStatusText');
                
                statusDot.className = 'status-dot connecting';
                statusText.textContent = 'Connecting...';
                
                // Connect to the phone via Bluetooth (filtered device list)
                const connected = await fingerprintAuth.connect(false);
                
                if (connected) {
                    // Update UI to show connected state
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Connected via Bluetooth';
                    
                    // Enable/disable buttons
                    document.getElementById('connectBluetoothButton').disabled = true;
                    document.getElementById('connectAllBluetoothButton').disabled = true;
                    document.getElementById('disconnectBluetoothButton').disabled = false;
                    document.getElementById('requestAuthButton').disabled = false;
                } else {
                    // Update UI to show connection failed
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'Connection failed';
                }
            } catch (error) {
                console.error('Bluetooth connection error:', error);
                
                // Update UI to show error
                const statusDot = document.getElementById('bluetoothStatusDot');
                const statusText = document.getElementById('bluetoothStatusText');
                
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = `Connection error: ${error.message}`;
            }
        }
        
        // Connect to phone via Bluetooth showing all available devices
        async function connectAllBluetooth() {
            try {
                // Update UI to show connecting state
                const statusDot = document.getElementById('bluetoothStatusDot');
                const statusText = document.getElementById('bluetoothStatusText');
                
                statusDot.className = 'status-dot connecting';
                statusText.textContent = 'Showing all Bluetooth devices...';
                
                // Connect to the phone via Bluetooth (show all devices)
                const connected = await fingerprintAuth.connect(true);
                
                if (connected) {
                    // Update UI to show connected state
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Connected via Bluetooth';
                    
                    // Enable/disable buttons
                    document.getElementById('connectBluetoothButton').disabled = true;
                    document.getElementById('connectAllBluetoothButton').disabled = true;
                    document.getElementById('disconnectBluetoothButton').disabled = false;
                    document.getElementById('requestAuthButton').disabled = false;
                } else {
                    // Update UI to show connection failed
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'Connection failed';
                }
            } catch (error) {
                console.error('Bluetooth connection error:', error);
                
                // Update UI to show error
                const statusDot = document.getElementById('bluetoothStatusDot');
                const statusText = document.getElementById('bluetoothStatusText');
                
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = `Connection error: ${error.message}`;
            }
        }
        
        // Disconnect from Bluetooth
        async function disconnectBluetooth() {
            try {
                await fingerprintAuth.disconnect();
                
                // Update UI to show disconnected state
                const statusDot = document.getElementById('bluetoothStatusDot');
                const statusText = document.getElementById('bluetoothStatusText');
                
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
                
                // Enable/disable buttons
                document.getElementById('connectBluetoothButton').disabled = false;
                document.getElementById('connectAllBluetoothButton').disabled = false;
                document.getElementById('disconnectBluetoothButton').disabled = true;
                document.getElementById('requestAuthButton').disabled = true;
                document.getElementById('authHapticMode').disabled = true;
                document.getElementById('authHapticIntensity').disabled = true;
                document.getElementById('authBrailleMessage').disabled = true;
                document.getElementById('sendAuthHapticButton').disabled = true;
                
                // Reset authentication status
                const authStatus = document.getElementById('authStatus');
                authStatus.innerHTML = '<i class="fas fa-fingerprint" style="font-size: 48px; color: var(--text-secondary);"></i><p>Not authenticated</p>';
            } catch (error) {
                console.error('Bluetooth disconnection error:', error);
            }
        }
        
        // Request fingerprint authentication
        async function requestAuthentication() {
            try {
                // Update UI to show authentication in progress
                const authStatus = document.getElementById('authStatus');
                authStatus.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 48px; color: var(--accent-color);"></i><p>Waiting for fingerprint verification...</p>';
                
                // Generate a challenge token for secure authentication
                const challengeToken = generateRandomToken();
                console.log('Generated challenge token:', challengeToken);
                
                // Request authentication from the phone with the challenge token
                const authenticated = await fingerprintAuth.requestAuthentication(null, false, challengeToken);
                
                if (authenticated) {
                    // Update UI to show authenticated state
                    authStatus.innerHTML = '<i class="fas fa-fingerprint" style="font-size: 48px; color: var(--success-color);"></i><p>Authentication successful</p>';
                    
                    // Enable haptic controls
                    document.getElementById('authHapticMode').disabled = false;
                    document.getElementById('authHapticIntensity').disabled = false;
                    document.getElementById('authBrailleMessage').disabled = false;
                    document.getElementById('sendAuthHapticButton').disabled = false;
                    
                    // Update braille tab authentication status if exists
                    const brailleAuthStatusDot = document.getElementById('brailleAuthStatusDot');
                    const brailleAuthStatusText = document.getElementById('brailleAuthStatusText');
                    if (brailleAuthStatusDot && brailleAuthStatusText) {
                        brailleAuthStatusDot.className = 'status-dot connected';
                        brailleAuthStatusText.textContent = 'Authenticated';
                    }
                } else {
                    // Update UI to show authentication failed
                    authStatus.innerHTML = '<i class="fas fa-fingerprint" style="font-size: 48px; color: var(--error-color);"></i><p>Authentication failed</p>';
                    
                    // Update braille tab authentication status if exists
                    const brailleAuthStatusDot = document.getElementById('brailleAuthStatusDot');
                    const brailleAuthStatusText = document.getElementById('brailleAuthStatusText');
                    if (brailleAuthStatusDot && brailleAuthStatusText) {
                        brailleAuthStatusDot.className = 'status-dot disconnected';
                        brailleAuthStatusText.textContent = 'Not authenticated';
                    }
                }
                
                // Helper function to generate a random token
                function generateRandomToken() {
                    const array = new Uint8Array(16);
                    window.crypto.getRandomValues(array);
                    return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                
                // Update UI to show error
                const authStatus = document.getElementById('authStatus');
                authStatus.innerHTML = `<i class="fas fa-fingerprint" style="font-size: 48px; color: var(--error-color);"></i><p>Error: ${error.message}</p>`;
            }
        }
        
        // Send authenticated haptic message
        async function sendAuthenticatedHapticMessage() {
            try {
                const message = document.getElementById('authBrailleMessage').value;
                const hapticMode = document.getElementById('authHapticMode').value;
                const intensity = parseFloat(document.getElementById('authHapticIntensity').value);
                
                if (!message) {
                    alert('Please enter a message to send');
                    return;
                }
                
                // Send the haptic message via Bluetooth
                await fingerprintAuth.sendAuthenticatedHapticMessage(message, hapticMode, intensity);
                
                // Show success message
                alert('Authenticated haptic message sent successfully');
            } catch (error) {
                console.error('Error sending authenticated haptic message:', error);
                alert(`Error sending message: ${error.message}`);
            }
        }
        
        // Update haptic settings based on user selections
        function updateHapticSettings() {
            const hapticMode = document.getElementById('hapticMode').value;
            const intensity = parseFloat(document.getElementById('hapticIntensity').value);
            
            // Update intensity display
            document.getElementById('intensityValue').textContent = intensity.toFixed(1);
            
            // Update messenger settings
            brailleMessenger.setSettings({
                hapticMode: hapticMode,
                intensity: intensity
            });
        }
        
        // Check if phone is connected via ADB
        window.checkPhoneConnection = function() {
            const statusDot = document.getElementById('phoneStatusDot');
            const statusText = document.getElementById('phoneStatusText');
            
            // Set status to connecting
            statusDot.className = 'status-dot connecting';
            statusText.textContent = 'Checking phone connection...';
            
            // In a real implementation, we would make an API call to check ADB connection
            // For now, we'll simulate the connection check
            setTimeout(() => {
                const connected = Math.random() > 0.3; // Simulate 70% chance of connected device
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Phone connected (RFCB123456)';
                    document.getElementById('sendBrailleMessage').disabled = false;
                } else {
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'No phone connected';
                    document.getElementById('sendBrailleMessage').disabled = true;
                }
            }, 1000);
        }
        
        // Expose functions to window for HTML event handlers
        window.toggleConnectionMethod = function() {
            const connectionMethod = document.getElementById('connectionMethod').value;
            const usbConnectionStatus = document.getElementById('usbConnectionStatus');
            const bluetoothConnectionControls = document.getElementById('bluetoothConnectionControls');
            
            if (connectionMethod === 'usb') {
                usbConnectionStatus.style.display = 'block';
                bluetoothConnectionControls.style.display = 'none';
                checkPhoneConnection();
            } else {
                usbConnectionStatus.style.display = 'none';
                bluetoothConnectionControls.style.display = 'block';
                
                // Initialize Bluetooth connector for braille if not already done
                if (!brailleBluetoothConnector) {
                    brailleBluetoothConnector = new BluetoothConnector();
                    if (brailleMessenger) {
                        brailleMessenger.setBluetoothConnector(brailleBluetoothConnector);
                        console.log('Bluetooth connector set for braille messaging');
                    }
                }
            }
        }
        
        // Connect to Bluetooth for braille messaging
        window.connectBrailleViaBluetooth = async function() {
            try {
                // Update UI to show connecting state
                const statusDot = document.getElementById('brailleBluetoothStatusDot');
                const statusText = document.getElementById('brailleBluetoothStatusText');
                const connectBtn = document.getElementById('connectBrailleBluetoothBtn');
                const disconnectBtn = document.getElementById('disconnectBrailleBluetoothBtn');
                
                statusDot.className = 'status-dot connecting';
                statusText.textContent = 'Connecting...';
                connectBtn.disabled = true;
                
                // Initialize Bluetooth connector for braille if not already done
                if (!brailleBluetoothConnector) {
                    brailleBluetoothConnector = new BluetoothConnector();
                }
                
                // Connect to Bluetooth device
                await brailleBluetoothConnector.connect();
                
                // Update UI to show connected state
                statusDot.className = 'status-dot connected';
                statusText.textContent = brailleBluetoothConnector.device ? 
                    `Connected to ${brailleBluetoothConnector.device.name}` : 'Connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                
                // Set the Bluetooth connector in the braille messenger
                brailleMessenger.setBluetoothConnector(brailleBluetoothConnector);
                
                // Initialize fingerprint authenticator if not already done
                if (!fingerprintAuth) {
                    fingerprintAuth = new FingerprintAuthenticator();
                    // Use the same Bluetooth connector
                    fingerprintAuth.bluetoothConnector = brailleBluetoothConnector;
                    console.log('Fingerprint authenticator initialized with braille Bluetooth connector');
                }
            } catch (error) {
                console.error('Error connecting to Bluetooth device:', error);
                
                // Update UI to show error
                const statusDot = document.getElementById('brailleBluetoothStatusDot');
                const statusText = document.getElementById('brailleBluetoothStatusText');
                const connectBtn = document.getElementById('connectBrailleBluetoothBtn');
                
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = `Error: ${error.message}`;
                connectBtn.disabled = false;
            }
        }
        
        // Disconnect from Bluetooth for braille messaging
        window.disconnectBrailleViaBluetooth = async function() {
            try {
                if (brailleBluetoothConnector) {
                    await brailleBluetoothConnector.disconnect();
                }
                
                // Update UI to show disconnected state
                const statusDot = document.getElementById('brailleBluetoothStatusDot');
                const statusText = document.getElementById('brailleBluetoothStatusText');
                const connectBtn = document.getElementById('connectBrailleBluetoothBtn');
                const disconnectBtn = document.getElementById('disconnectBrailleBluetoothBtn');
                
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            } catch (error) {
                console.error('Error disconnecting from Bluetooth device:', error);
                alert(`Error disconnecting: ${error.message}`);
            }
        }
        
        // Send braille message as haptic feedback to phone
        window.sendBrailleMessage = async function() {
            const messageText = document.getElementById('brailleMessage').value;
            const connectionMethod = document.getElementById('connectionMethod').value;
            
            if (!messageText.trim()) {
                alert('Please enter a message to send');
                return;
            }
            
            if (connectionMethod === 'bluetooth') {
                // Send via Bluetooth
                try {
                    // Get haptic settings
                    const hapticMode = document.getElementById('hapticMode').value;
                    const intensity = parseFloat(document.getElementById('hapticIntensity').value);
                    
                    // Check if connected via Bluetooth
                    if (!brailleBluetoothConnector || !brailleBluetoothConnector.isConnected) {
                        alert('Please connect to a Bluetooth device first');
                        return;
                    }
                    
                    // Check if authenticated
                    if (!fingerprintAuth || !fingerprintAuth.isUserAuthenticated()) {
                        // Show authentication modal
                        const shouldAuthenticate = confirm('Authentication required to send braille messages via Bluetooth. Would you like to authenticate now?');
                        
                        if (shouldAuthenticate) {
                            // Switch to fingerprint tab
                            switchTab('fingerprint');
                            return;
                        } else {
                            return;
                        }
                    }
                    
                    // Send authenticated message via Bluetooth
                    await fingerprintAuth.sendAuthenticatedHapticMessage(messageText, hapticMode, intensity);
                    
                    // Add to history
                    addToMessageHistory(messageText);
                    
                    alert('Authenticated braille message sent successfully via Bluetooth!');
                    
                    // Clear message input
                    document.getElementById('brailleMessage').value = '';
                    updateBraillePreview();
                } catch (error) {
                    console.error('Error sending braille message via Bluetooth:', error);
                    alert(`Error sending message: ${error.message}`);
                }
            } else {
                // Generate ADB command for haptic feedback
                const adbCommand = brailleMessenger.sendBrailleMessage(messageText);
                
                // Display in terminal
                const terminalOutput = document.querySelector('.terminal-output') || document.createElement('div');
                if (terminalOutput) {
                    terminalOutput.innerHTML += `<div class="terminal-line">$ ${adbCommand}</div>`;
                }
                
                // Actually execute the ADB command via fetch to our local ADB server
                fetch('http://localhost:3000/execute-adb-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command: adbCommand }),
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Command executed:', data);
                    if (terminalOutput) {
                        terminalOutput.innerHTML += `<div class="terminal-line">${data.output || 'Command executed'}</div>`;
                        // Scroll terminal to bottom if it exists
                        terminalOutput.scrollTop = terminalOutput.scrollHeight;
                    }
                    
                    // Add to history
                    addToMessageHistory(messageText);
                    
                    // Clear message input
                    document.getElementById('brailleMessage').value = '';
                    updateBraillePreview();
                })
            .catch(error => {
                console.error('Error executing command:', error);
                alert('Error sending haptic message. Make sure your phone is connected via USB with debugging enabled.');
                
                // Fallback: Execute command directly using the symbios-watch-bridge.sh script
                const fallbackCommand = `bash ${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'))}}/symbios-watch-bridge.sh execute-adb "${adbCommand}"`;
                console.log('Trying fallback command:', fallbackCommand);
                
                if (terminalOutput) {
                    terminalOutput.innerHTML += `<div class="terminal-line">Trying fallback method...</div>`;
                    terminalOutput.innerHTML += `<div class="terminal-line">$ ${fallbackCommand}</div>`;
                }
                
                // Simulate success for now
                setTimeout(() => {
                    // Add to history
                    addToMessageHistory(messageText);
                    
                    // Clear message input
                    document.getElementById('brailleMessage').value = '';
                    updateBraillePreview();
                    
                    alert('Haptic message sent via fallback method!');
                }, 1000);
            });
            }
        }
        
        // Add message to history
        function addToMessageHistory(message) {
            const historyList = document.getElementById('brailleHistoryList');
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const unicodeBraille = brailleMessenger.getUnicodeBraille(message);
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <div class="history-message">
                    <div>${message}</div>
                    <div class="history-braille">${unicodeBraille}</div>
                </div>
                <div class="history-time">${timeString}</div>
            `;
            
            // Add to top of list
            historyList.insertBefore(historyItem, historyList.firstChild);
        }
        
        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            initTabs();
            initBrailleHaptic();
            checkPhoneConnection();
        });
    </script>
</body>
</html>
