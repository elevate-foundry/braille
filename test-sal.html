<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sal Assistant Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2196F3;
            margin-top: 0;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #4CAF50;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #2196F3;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0b7dda;
        }
        .log-container {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 6px;
            border-bottom: 1px solid #eee;
        }
        .log-entry.info {
            color: #2196F3;
        }
        .log-entry.error {
            color: #F44336;
        }
        .log-entry.success {
            color: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sal Assistant Test Page</h1>
        
        <div class="test-section">
            <h2>Sal Assistant Status</h2>
            <button id="check-status">Check Status</button>
            <button id="test-greeting">Test Greeting</button>
            <button id="test-identification">Test Identification</button>
            <button id="reset-sal">Reset Sal</button>
        </div>
        
        <div class="test-section">
            <h2>Device Information</h2>
            <button id="show-device-info">Show Device Info</button>
            <button id="create-test-device">Create Test Device</button>
            <div id="device-info-display" style="margin-top: 10px; font-size: 14px;"></div>
        </div>
        
        <div class="test-section">
            <h2>BBID Management</h2>
            <button id="list-devices">List Devices</button>
            <button id="export-current-device">Export Current Device</button>
            <div id="devices-list" style="margin-top: 10px; font-size: 14px;"></div>
        </div>
        
        <div class="log-container" id="log-container">
            <div class="log-entry info">Test console initialized. Logs will appear here.</div>
        </div>
    </div>

    <!-- Load BBID Integration -->
    <script src="bbid/demos/js/device-fingerprint.js"></script>
    <script src="bbid/demos/js/bbid-behavioral.js"></script>
    
    <!-- Load Common Scripts -->
    <script src="js/common.js"></script>
    
    <!-- Load Sal CSS -->
    <link rel="stylesheet" href="css/sal/sal.css">
    
    <!-- Load Sal Assistant -->
    <script src="js/sal/sal.js"></script>
    
    <script>
        // Custom logging to display in the page
        const logContainer = document.getElementById('log-container');
        
        function logToPage(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Also log to console
            if (type === 'error') {
                console.error(message);
            } else if (type === 'success') {
                console.log('%c' + message, 'color: green');
            } else {
                console.log(message);
            }
        }
        
        // Override console.log for our test page
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        console.log = function() {
            originalConsoleLog.apply(console, arguments);
            const message = Array.from(arguments).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            logToPage(message, 'info');
        };
        
        console.error = function() {
            originalConsoleError.apply(console, arguments);
            const message = Array.from(arguments).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            logToPage(message, 'error');
        };
        
        console.warn = function() {
            originalConsoleWarn.apply(console, arguments);
            const message = Array.from(arguments).map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            logToPage(message, 'info');
        };
        
        // Wait for Sal to initialize
        document.addEventListener('DOMContentLoaded', function() {
            logToPage('DOM loaded, waiting for Sal to initialize...', 'info');
            
            // Check if Sal is available every 500ms
            const checkSalInterval = setInterval(() => {
                if (window.salAssistant && window.salAssistant.isVisible) {
                    clearInterval(checkSalInterval);
                    logToPage('Sal Assistant initialized successfully!', 'success');
                    setupEventListeners();
                }
            }, 500);
            
            // Timeout after 10 seconds
            setTimeout(() => {
                clearInterval(checkSalInterval);
                if (!window.salAssistant || !window.salAssistant.isVisible) {
                    logToPage('Sal Assistant initialization timed out. Check console for errors.', 'error');
                }
            }, 10000);
        });
        
        function setupEventListeners() {
            // Status section
            document.getElementById('check-status').addEventListener('click', () => {
                logToPage('Checking Sal status...', 'info');
                if (window.salAssistant) {
                    const status = {
                        isVisible: window.salAssistant.isVisible,
                        isSpeaking: window.salAssistant.isSpeaking,
                        currentAnimation: window.salAssistant.currentAnimation,
                        deviceFingerprint: window.salAssistant.deviceFingerprint ? 'Available' : 'Not available',
                        behavioralData: window.salAssistant.behavioralData ? 'Available' : 'Not available',
                        position: window.salAssistant.options.position
                    };
                    logToPage('Sal status: ' + JSON.stringify(status, null, 2), 'success');
                } else {
                    logToPage('Sal not initialized', 'error');
                }
            });
            
            document.getElementById('test-greeting').addEventListener('click', () => {
                logToPage('Testing greeting...', 'info');
                if (window.salAssistant) {
                    window.salAssistant.speak('Hello! I\'m Sal, your BrailleBuddy assistant. I\'m here to help you navigate the BrailleBuddy ecosystem.');
                    logToPage('Greeting message sent to Sal', 'success');
                } else {
                    logToPage('Sal not initialized', 'error');
                }
            });
            
            document.getElementById('test-identification').addEventListener('click', () => {
                logToPage('Testing identification...', 'info');
                if (window.salAssistant) {
                    // Get user identity if available
                    if (window.BBID && typeof window.BBID.getIdentity === 'function') {
                        window.BBID.getIdentity().then(identity => {
                            logToPage('Identity retrieved: ' + JSON.stringify(identity), 'success');
                            window.salAssistant.speak(`I've identified you with ID: ${identity.id}. Your confidence level is ${identity.confidence}.`);
                        }).catch(error => {
                            logToPage('Error getting identity: ' + error.message, 'error');
                        });
                    } else {
                        logToPage('BBID identity provider not available', 'error');
                        window.salAssistant.speak('I cannot identify you at the moment. BBID identity provider is not available.');
                    }
                } else {
                    logToPage('Sal not initialized', 'error');
                }
            });
            
            document.getElementById('reset-sal').addEventListener('click', () => {
                logToPage('Resetting Sal...', 'info');
                if (window.salAssistant) {
                    // Hide Sal
                    window.salAssistant.hide();
                    
                    // Wait a second and show again
                    setTimeout(() => {
                        window.salAssistant.show();
                        window.salAssistant.speak('I\'ve been reset and I\'m ready to help you again!');
                        logToPage('Sal reset complete', 'success');
                    }, 1000);
                } else {
                    logToPage('Sal not initialized', 'error');
                }
            });
            
            // Device info section
            document.getElementById('show-device-info').addEventListener('click', () => {
                logToPage('Getting device info...', 'info');
                const deviceInfoDisplay = document.getElementById('device-info-display');
                
                if (window.salAssistant && window.salAssistant.deviceFingerprint) {
                    const deviceInfo = window.salAssistant.deviceFingerprint;
                    deviceInfoDisplay.innerHTML = '<pre>' + JSON.stringify(deviceInfo, null, 2) + '</pre>';
                    logToPage('Device info retrieved successfully', 'success');
                    
                    // Have Sal explain the fingerprint
                    window.salAssistant.speak(`I can see your device fingerprint. Your visitor ID is ${deviceInfo.visitorId.substring(0, 8)}...`);
                } else {
                    deviceInfoDisplay.innerHTML = '<p>Device fingerprint not available</p>';
                    logToPage('Device fingerprint not available', 'error');
                    
                    if (window.salAssistant) {
                        window.salAssistant.speak('I cannot access your device fingerprint at the moment.');
                    }
                }
            });
            
            document.getElementById('create-test-device').addEventListener('click', () => {
                logToPage('Creating test behavioral data...', 'info');
                
                // Simulate behavioral data collection
                const simulatedBehavioralData = {
                    keyboard: {
                        typingSpeed: Math.floor(Math.random() * 100) + 50, // 50-150 WPM
                        keyPressTime: Math.floor(Math.random() * 100) + 100, // 100-200ms
                        errorRate: Math.random() * 0.1, // 0-10% error rate
                        commonNgrams: ['th', 'he', 'in', 'er', 'an']
                    },
                    mouse: {
                        averageSpeed: Math.floor(Math.random() * 500) + 500, // 500-1000 px/s
                        clickFrequency: Math.floor(Math.random() * 50) + 10, // 10-60 clicks/min
                        doubleClickSpeed: Math.floor(Math.random() * 100) + 200, // 200-300ms
                        scrollPattern: Math.random() > 0.5 ? 'smooth' : 'choppy'
                    },
                    session: {
                        timeOfDay: new Date().getHours(),
                        sessionDuration: Math.floor(Math.random() * 3600) + 600, // 10-70 minutes
                        pageViewsPerSession: Math.floor(Math.random() * 10) + 5 // 5-15 pages
                    }
                };
                
                // Update Sal's behavioral data
                if (window.salAssistant) {
                    window.salAssistant.behavioralData = simulatedBehavioralData;
                    logToPage('Test behavioral data created successfully!', 'success');
                    
                    // Display the data
                    const deviceInfoDisplay = document.getElementById('device-info-display');
                    deviceInfoDisplay.innerHTML = '<pre>' + JSON.stringify(simulatedBehavioralData, null, 2) + '</pre>';
                    
                    // Have Sal explain the behavioral data
                    window.salAssistant.speak('I\'ve analyzed your behavioral patterns. Your typing speed is ' + 
                        simulatedBehavioralData.keyboard.typingSpeed + ' words per minute, and your mouse movement is ' + 
                        simulatedBehavioralData.mouse.scrollPattern + '.');
                } else {
                    logToPage('Sal not initialized', 'error');
                }
            });
            
            // BBID Management section
            document.getElementById('list-devices').addEventListener('click', () => {
                logToPage('Checking behavioral data...', 'info');
                const devicesList = document.getElementById('devices-list');
                
                if (window.salAssistant && window.salAssistant.behavioralData) {
                    devicesList.innerHTML = '<pre>' + JSON.stringify(window.salAssistant.behavioralData, null, 2) + '</pre>';
                    logToPage('Behavioral data retrieved successfully', 'success');
                    
                    // Have Sal explain the behavioral data
                    window.salAssistant.speak('Here\'s your behavioral fingerprint data. This helps me recognize you across sessions.');
                } else {
                    devicesList.innerHTML = '<p>No behavioral data available</p>';
                    logToPage('No behavioral data available', 'info');
                    
                    if (window.salAssistant) {
                        window.salAssistant.speak('I don\'t have any behavioral data for you yet. Try interacting with the page more.');
                    }
                }
            });
            
            document.getElementById('export-current-device').addEventListener('click', () => {
                logToPage('Exporting device data...', 'info');
                
                if (window.salAssistant) {
                    try {
                        // Combine device fingerprint and behavioral data
                        const exportData = {
                            deviceFingerprint: window.salAssistant.deviceFingerprint || null,
                            behavioralData: window.salAssistant.behavioralData || null,
                            timestamp: new Date().toISOString(),
                            userAgent: navigator.userAgent
                        };
                        
                        // Create a download link
                        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
                        const downloadAnchorNode = document.createElement('a');
                        downloadAnchorNode.setAttribute("href", dataStr);
                        downloadAnchorNode.setAttribute("download", "bbid-export.json");
                        document.body.appendChild(downloadAnchorNode);
                        downloadAnchorNode.click();
                        downloadAnchorNode.remove();
                        
                        logToPage('Device data exported successfully!', 'success');
                        window.salAssistant.speak('I\'ve exported your device data. You can use this file to analyze your behavioral patterns.');
                    } catch (error) {
                        logToPage('Error exporting device data: ' + error.message, 'error');
                    }
                } else {
                    logToPage('No current device identified or BBID Manager not available', 'error');
                }
            });
        }
    </script>
</body>
</html>
